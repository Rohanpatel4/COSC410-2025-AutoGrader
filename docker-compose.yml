x-logging: &default-logging
  logging:
    driver: json-file
    options:
      max-size: 100M

services:
  # ===================== Inner Docker daemon (DinD) =====================
  dind:
    image: docker:27-dind
    privileged: true
    command:
      - "--host=tcp://0.0.0.0:2375"
      - "--storage-driver=overlay2"
    environment:
      DOCKER_TLS_CERTDIR: ""
      DOCKER_DRIVER: overlay2
    ports:
      - "127.0.0.1:12735:2375"  # Docker daemon API
      - "2358:2358"              # Judge0 API (forwarded from inner Docker)
    volumes:
      - dind-data:/var/lib/docker
      - ./infra/judge0:/workspace/j0:rw
    networks:
      - app-network
    restart: always

  # ===================== Judge0 bootstrap inside DinD =====================
  j0ctl:
    image: docker:27-cli
    depends_on:
      - dind
    environment:
      DOCKER_HOST: tcp://dind:2375
    volumes:
      - ./infra/judge0:/workspace/j0:ro
    command:
      - /bin/sh
      - -c
      - |
        echo "[j0ctl] Waiting for DinD to be ready..."
        sleep 15
        echo "[j0ctl] Starting Judge0 stack..."
        docker compose -f /workspace/j0/docker-compose.yml up -d
        echo "[j0ctl] Judge0 stack started."
        docker compose -f /workspace/j0/docker-compose.yml ps
        echo ""
        echo "[j0ctl] ✓ Judge0 accessible at http://dind:2358 (from backend)"
        echo "[j0ctl] ✓ Judge0 accessible at http://localhost:2358 (from host)"
        echo "[j0ctl] Keeping container alive..."
        tail -f /dev/null
    networks:
      - app-network
    restart: always

  # ===================== Backend (FastAPI) =====================
  backend:
    build:
      context: .
      dockerfile: infra/docker/backend.Dockerfile
    environment:
      - DATABASE_URL=sqlite:///./backend/app.db
      - CORS_ORIGINS=["http://localhost:5173"]
      - PYTHONUNBUFFERED=1
      # Judge0 runs in DinD at http://dind:2358
      - JUDGE0_URL=http://dind:2358
    ports:
      - "8000:8000"
    volumes:
      - ./backend:/app/backend               # your current bind mount
      - storage_data:/app/storage
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request as u; u.urlopen('http://localhost:8000/docs'); print('ok')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    depends_on:
      - dind
      - j0ctl
    networks:
      - app-network
    <<: *default-logging
    restart: always

  # ===================== Frontend (unchanged) =====================
  frontend:
    build:
      context: .
      dockerfile: infra/docker/frontend.Dockerfile
    environment:
      - VITE_API_URL=/api
    ports:
      - "5173:80"
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - app-network
    <<: *default-logging
    restart: always

# ===================== Volumes =====================
volumes:
  storage_data:        # backend storage
  dind-data:           # inner daemon's image cache/layers

# ===================== Network =====================
networks:
  app-network:
    driver: bridge

  