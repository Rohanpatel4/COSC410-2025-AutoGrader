x-logging: &default-logging
  logging:
    driver: json-file
    options:
      max-size: 100M

services:
  # ===================== Inner Docker daemon (rootless; no --privileged) =====================
  dind:
    image: docker:27-dind-rootless
    privileged: true
    command:
      - "--host=tcp://0.0.0.0:2375"
      - "--host=unix:///run/user/1000/docker.sock"
      - "--storage-driver=overlay2"
      - "--iptables=false"
    environment:
      DOCKER_TLS_CERTDIR: ""        # dev only: disable TLS for simplicity
      DOCKER_DRIVER: overlay2
    tmpfs:
      - /tmp:rw,nosuid,size=256m
    ports:
      - "127.0.0.1:12735:2375"      # optional: talk to inner daemon from host for debugging
    volumes:
      - dind-data:/var/lib/docker   # inner daemon image/layer cache
    networks:
      - app-network
    <<: *default-logging
    restart: always

  # ===================== Runner (talks to inner daemon; great for manual tests) =====================
  runner:
    build:
      context: ./runner
      dockerfile: Dockerfile
    environment:
      DOCKER_HOST: tcp://dind:2375   # points CLI to the inner daemon
    volumes:
      - runner-tmp:/runner/tmp       # shared scratch for submissions/tests
    depends_on:
      - dind
    networks:
      - app-network
    <<: *default-logging
    restart: always

  # ===================== Backend (FastAPI) =====================
  backend:
    build:
      context: .
      dockerfile: infra/docker/backend.Dockerfile
    environment:
      - DATABASE_URL=sqlite:///./backend/app.db
      - CORS_ORIGINS=["http://localhost:5173"]
      - DOCKER_HOST=tcp://dind:2375         # let backend call the inner Docker daemon
      - PYTHONUNBUFFERED=1
    ports:
      - "8000:8000"
    volumes:
      - ./backend:/app/backend               # your current bind mount
      - storage_data:/app/storage
      - runner-tmp:/runner/tmp               # share the scratch area with runner & inner jobs
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request as u; u.urlopen('http://localhost:8000/docs'); print('ok')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    depends_on:
      - dind                                 # used to depend on judge0; now depends on inner Docker
    networks:
      - app-network
    <<: *default-logging
    restart: always

  # ===================== Judge0 Services =====================
  judge0-db:
    image: postgres:16.2
    environment:
      POSTGRES_DB: judge0
      POSTGRES_USER: judge0
      POSTGRES_PASSWORD: judge0_password
    volumes:
      - judge0-db-data:/var/lib/postgresql/data
    networks:
      - app-network
    <<: *default-logging
    restart: always

  judge0-redis:
    image: redis:7.2.4
    command: ["redis-server", "--appendonly", "no", "--requirepass", "judge0_redis_password"]
    networks:
      - app-network
    <<: *default-logging
    restart: always

  judge0:
    build:
      context: ./backend/backend/judge0-custom
      dockerfile: Dockerfile
      target: production
    privileged: true
    environment:
      JUDGE0_TELEMETRY_ENABLE: "false"
      RAILS_ENV: production
      POSTGRES_HOST: judge0-db
      POSTGRES_DB: judge0
      POSTGRES_USER: judge0
      POSTGRES_PASSWORD: judge0_password
      REDIS_HOST: judge0-redis
      REDIS_PASSWORD: judge0_redis_password
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
    ports:
      - "2358:2358"
    depends_on:
      - judge0-db
      - judge0-redis
    networks:
      - app-network
    <<: *default-logging
    restart: always

  judge0-workers:
    build:
      context: ./backend/backend/judge0-custom
      dockerfile: Dockerfile
      target: production
    privileged: true
    command: ["./scripts/workers"]
    environment:
      JUDGE0_TELEMETRY_ENABLE: "false"
      RAILS_ENV: production
      POSTGRES_HOST: judge0-db
      POSTGRES_DB: judge0
      POSTGRES_USER: judge0
      POSTGRES_PASSWORD: judge0_password
      REDIS_HOST: judge0-redis
      REDIS_PASSWORD: judge0_redis_password
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
    depends_on:
      - judge0-db
      - judge0-redis
      - judge0
    networks:
      - app-network
    <<: *default-logging
    restart: always

  # ===================== Frontend (unchanged) =====================
  frontend:
    build:
      context: .
      dockerfile: infra/docker/frontend.Dockerfile
    environment:
      - VITE_API_URL=/api
    ports:
      - "5173:80"
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - app-network
    <<: *default-logging
    restart: always

# ===================== Volumes =====================
volumes:
  storage_data:        # you already had this for backend storage
  dind-data:           # inner daemon's image cache/layers
  runner-tmp:          # job scratch shared by backend/runner
  judge0-db-data:      # judge0 database data

# ===================== Network =====================
networks:
  app-network:
    driver: bridge


